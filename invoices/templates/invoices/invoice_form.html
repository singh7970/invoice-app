{% extends 'invoices/base.html' %}

{% block title %}Create Invoice{% endblock %}

{% block content %}
<div class="card">
    <div class="page-header">
        <h1>Create New Invoice</h1>
        <a href="{% url 'master_dashboard' %}" class="btn btn-secondary">Manage Master Data</a>
    </div>

    <form method="post">
        {% csrf_token %}

        <div class="grid-2">
            <div>
                <h3>Seller Details</h3>
                <div class="form-group">
                    <label>Select Saved Seller</label>
                    <select id="sender-select" onchange="populateSender()">
                        <option value="">-- Select --</option>
                        {% for sender in senders %}
                        <option value="{{ sender.id }}" data-name="{{ sender.name }}"
                            data-address="{{ sender.address }}" data-state="{{ sender.state }}"
                            data-gstin="{{ sender.gstin }}">
                            {{ sender.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    {{ form.sender_name }}
                </div>
                <div class="form-group">
                    <label>Address</label>
                    {{ form.sender_address }}
                </div>
                <div class="form-group">
                    <label>State</label>
                    {{ form.sender_state }}
                </div>
                <div class="form-group">
                    <label>GSTIN</label>
                    {{ form.sender_gstin }}
                </div>
            </div>

            <div>
                <h3>Customer Details</h3>
                <div class="form-group">
                    <label>Select Saved Customer</label>
                    <select id="client-select" onchange="populateClient()">
                        <option value="">-- Select --</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}" data-name="{{ client.name }}"
                            data-address="{{ client.address }}" data-state="{{ client.state }}"
                            data-gstin="{{ client.gstin }}">
                            {{ client.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    {{ form.client_name }}
                </div>
                <div class="form-group">
                    <label>Address</label>
                    {{ form.client_address }}
                </div>
                <div class="form-group">
                    <label>State</label>
                    {{ form.client_state }}
                </div>
                <div class="form-group">
                    <label>GSTIN</label>
                    {{ form.client_gstin }}
                </div>
            </div>
        </div>

        <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

        <div class="grid-3">
            <div class="form-group">
                <label>Invoice Number</label>
                {{ form.invoice_number }}
            </div>
            <div class="form-group">
                <label>Date</label>
                {{ form.invoice_date }}
            </div>
            <div class="form-group checkbox-wrapper" style="margin-top: 1.75rem;">
                {{ form.is_gst_applicable }}
                <label for="{{ form.is_gst_applicable.id_for_label }}" style="margin: 0;">GST Applicable</label>
            </div>
        </div>

        <h3>Items</h3>

        <!-- Product Select Template (Hidden) -->
        <div style="display:none;">
            <select id="product-select-template">
                <option value="">-- Select Product --</option>
                {% for product in products %}
                <option value="{{ product.id }}" data-desc="{{ product.description }}" data-rate="{{ product.rate }}"
                    data-tax="{{ product.tax_rate }}">
                    {{ product.description }}
                </option>
                {% endfor %}
            </select>
        </div>

        {{ formset.management_form }}
        <div id="items-container">
            {% for form in formset %}
            <div class="item-row grid-2"
                style="grid-template-columns: 3fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                <div class="form-group">
                    <label>Description</label>
                    <select class="product-select" onchange="populateProduct(this)" style="margin-bottom: 0.5rem;">
                        <option value="">-- Select Product --</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" data-desc="{{ product.description }}"
                            data-rate="{{ product.rate }}" data-tax="{{ product.tax_rate }}">
                            {{ product.description }}
                        </option>
                        {% endfor %}
                    </select>
                    {{ form.description }}
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    {{ form.quantity }}
                </div>
                <div class="form-group">
                    <label>Rate</label>
                    {{ form.rate }}
                </div>
                <div class="form-group">
                    <label>Tax Rate (%)</label>
                    {{ form.tax_rate }}
                </div>
                {{ form.id }}
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add-item" class="btn btn-secondary" style="margin-bottom: 2rem;">+ Add Item</button>

        <div class="text-right">
            <button type="submit" class="btn btn-primary">Generate Invoice</button>
        </div>
    </form>
</div>

<script>
    function populateSender() {
        const select = document.getElementById('sender-select');
        const option = select.options[select.selectedIndex];
        if (option.value) {
            document.getElementById('id_sender_name').value = option.dataset.name;
            document.getElementById('id_sender_address').value = option.dataset.address;
            document.getElementById('id_sender_state').value = option.dataset.state;
            document.getElementById('id_sender_gstin').value = option.dataset.gstin;
        }
    }

    function populateClient() {
        const select = document.getElementById('client-select');
        const option = select.options[select.selectedIndex];
        if (option.value) {
            document.getElementById('id_client_name').value = option.dataset.name;
            document.getElementById('id_client_address').value = option.dataset.address;
            document.getElementById('id_client_state').value = option.dataset.state;
            document.getElementById('id_client_gstin').value = option.dataset.gstin;
        }
    }

    function populateProduct(select) {
        const option = select.options[select.selectedIndex];
        if (option.value) {
            const row = select.closest('.item-row');
            row.querySelector('[name$="-description"]').value = option.dataset.desc;
            row.querySelector('[name$="-rate"]').value = option.dataset.rate;
            row.querySelector('[name$="-tax_rate"]').value = option.dataset.tax;
        }
    }

    document.getElementById('add-item').addEventListener('click', function () {
        const container = document.getElementById('items-container');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        const currentFormCount = parseInt(totalForms.value);

        const newRow = container.firstElementChild.cloneNode(true);
        const regex = new RegExp(`items-0`, 'g');
        newRow.innerHTML = newRow.innerHTML.replace(regex, `items-${currentFormCount}`);

        // Clear values
        const inputs = newRow.querySelectorAll('input');
        inputs.forEach(input => input.value = '');

        // Reset select
        const select = newRow.querySelector('select');
        select.selectedIndex = 0;

        container.appendChild(newRow);
        totalForms.value = currentFormCount + 1;
    });
</script>
{% endblock %}